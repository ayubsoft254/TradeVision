{% extends 'base.html' %}

{% block title %}Trade Initiation Status - TradeVision{% endblock %}

{% block extra_css %}
<style>
    .status-container {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .success-icon {
        color: #10b981;
        font-size: 3rem;
    }
    
    .error-icon {
        color: #ef4444;
        font-size: 3rem;
    }
    
    .progress-bar {
        background: #e5e7eb;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        height: 100%;
        border-radius: 10px;
        animation: progress-animation 3s ease-in-out infinite;
    }
    
    @keyframes progress-animation {
        0% { width: 10%; }
        50% { width: 80%; }
        100% { width: 10%; }
    }
    
    .status-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Trade Initiation</h1>
            <p class="text-gray-600">Please wait while we process your trade request</p>
        </div>
        
        <!-- Status Container -->
        <div class="status-container">
            <div id="status-content" class="text-center">
                <!-- Initial loading state -->
                <div id="loading-state">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Initiating Trade...</h3>
                    <p class="text-gray-600 mb-4">Setting up your trade parameters and creating the order</p>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">This usually takes 5-10 seconds</p>
                </div>
                
                <!-- Success state (hidden initially) -->
                <div id="success-state" class="hidden">
                    <i class="fas fa-check-circle success-icon mb-4"></i>
                    <h3 class="text-xl font-semibold text-green-800 mb-2">Trade Initiated Successfully!</h3>
                    <div class="status-card">
                        <div id="trade-details">
                            <!-- Trade details will be populated via JavaScript -->
                        </div>
                    </div>
                    <div class="mt-6 space-x-4">
                        <a href="{% url 'trading:trades' %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            View My Trades
                        </a>
                        <a href="{% url 'trading:dashboard' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            Back to Dashboard
                        </a>
                    </div>
                </div>
                
                <!-- Error state (hidden initially) -->
                <div id="error-state" class="hidden">
                    <i class="fas fa-exclamation-circle error-icon mb-4"></i>
                    <h3 class="text-xl font-semibold text-red-800 mb-2">Trade Initiation Failed</h3>
                    <div class="status-card">
                        <p class="text-red-600 mb-4" id="error-message">
                            An error occurred while initiating your trade.
                        </p>
                    </div>
                    <div class="mt-6 space-x-4">
                        <a href="{% url 'trading:initiate_trade' %}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            Try Again
                        </a>
                        <a href="{% url 'trading:dashboard' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            Back to Dashboard
                        </a>
                    </div>
                </div>
                
                <!-- No task state -->
                <div id="no-task-state" class="{% if has_task %}hidden{% endif %}">
                    <i class="fas fa-info-circle text-blue-600 text-3xl mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Active Trade Initiation</h3>
                    <p class="text-gray-600 mb-6">There's no trade initiation process currently running.</p>
                    <div class="space-x-4">
                        <a href="{% url 'trading:initiate_trade' %}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            Start New Trade
                        </a>
                        <a href="{% url 'trading:dashboard' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tips Section -->
        <div class="mt-8 bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <strong>What's happening?</strong> We're processing your trade request asynchronously to ensure system stability. 
                        Once complete, your trade will run for 24 hours and generate profits based on market conditions.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for status checking -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taskId = '{{ task_id }}';
    const hasTask = {{ has_task|yesno:"true,false" }};
    
    if (hasTask && taskId) {
        checkTradeStatus(taskId);
    }
    
    function checkTradeStatus(taskId) {
        fetch(`{% url 'trading:check_trade_status' %}?task_id=${taskId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.ready) {
                if (data.success) {
                    showSuccessState(data.result);
                } else {
                    showErrorState(data.error || 'Unknown error occurred');
                }
            } else {
                // Task still running, check again in 2 seconds
                setTimeout(() => checkTradeStatus(taskId), 2000);
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
            showErrorState('Failed to check trade status. Please refresh the page.');
        });
    }
    
    function showSuccessState(result) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('success-state').classList.remove('hidden');
        
        // Populate trade details
        const detailsHtml = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                <div>
                    <p class="text-sm text-gray-600">Trade ID</p>
                    <p class="font-semibold">${result.trade_id}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Expected Profit</p>
                    <p class="font-semibold text-green-600">${result.profit_amount}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Profit Rate</p>
                    <p class="font-semibold">${result.profit_rate}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Completion Time</p>
                    <p class="font-semibold">${new Date(result.end_time).toLocaleString()}</p>
                </div>
            </div>
        `;
        document.getElementById('trade-details').innerHTML = detailsHtml;
    }
    
    function showErrorState(error) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('error-message').textContent = error;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}