{% extends 'base.html' %}

{% block title %}Initiate Trade - TradeVision{% endblock %}

{% block extra_css %}
<style>
    .investment-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
    }
    
    .investment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        border-color: #3b82f6;
    }
    
    .investment-card.selected {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    
    .trading-hours-card {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .trading-closed-card {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .step-indicator {
        transition: all 0.3s ease;
    }
    
    .step-indicator.active {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        transform: scale(1.1);
    }
    
    .step-indicator.completed {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .confirmation-modal {
        backdrop-filter: blur(10px);
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    .trade-preview {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 1px solid #bae6fd;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center space-x-4">
                <div class="step-indicator active w-10 h-10 rounded-full text-white flex items-center justify-center text-sm font-semibold">
                    1
                </div>
                <div class="w-16 h-1 bg-gray-200"></div>
                <div class="step-indicator w-10 h-10 bg-gray-200 rounded-full text-gray-500 flex items-center justify-center text-sm font-semibold">
                    2
                </div>
                <div class="w-16 h-1 bg-gray-200"></div>
                <div class="step-indicator w-10 h-10 bg-gray-200 rounded-full text-gray-500 flex items-center justify-center text-sm font-semibold">
                    3
                </div>
            </div>
            <div class="flex justify-center mt-3">
                <div class="text-center">
                    <div class="text-sm font-medium text-gray-900">Select Investment</div>
                    <div class="text-xs text-gray-500">Step 1 of 3</div>
                </div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold font-heading text-gray-900 mb-2">
                Initiate New Trade
            </h1>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Select an active investment to start a new 24-hour trading session and earn daily profits
            </p>
        </div>

        <!-- Trading Hours Status -->
        <div class="mb-8">
            {% if trading_allowed %}
                <div class="trading-hours-card rounded-2xl p-6 text-white text-center">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <i class="fas fa-chart-line text-2xl pulse-animation"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Markets Are Open</h3>
                    <p class="opacity-90">Perfect timing! You can start trading now during market hours (Mon-Fri, 8AM-6PM)</p>
                </div>
            {% else %}
                <div class="trading-closed-card rounded-2xl p-6 text-white text-center">
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <i class="fas fa-pause-circle text-2xl"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Markets Are Closed</h3>
                    <p class="opacity-90">Trading is only available Monday to Friday, 8:00 AM to 6:00 PM. Please return during market hours.</p>
                </div>
            {% endif %}
        </div>

        {% if trading_allowed %}
        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Investment Selection -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl p-6 card-shadow">
                    <h2 class="text-xl font-semibold text-gray-900 mb-6">
                        Select Investment to Trade
                    </h2>

                    {% if available_investments %}
                        <form method="post" id="trade-form">
                            {% csrf_token %}
                            
                            <div class="space-y-4 mb-6">
                                {% for investment in available_investments %}
                                <div class="investment-card rounded-lg p-6" 
                                     onclick="selectInvestment({{ investment.id }}, '{{ investment.package.display_name }}', {{ investment.total_investment }}, {{ investment.package.profit_min }}, {{ investment.package.profit_max }}, {{ investment.package.duration_hours }})">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-4">
                                                <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                                    <i class="fas fa-box text-primary-600 text-lg"></i>
                                                </div>
                                                <div>
                                                    <h3 class="text-lg font-semibold text-gray-900">
                                                        {{ investment.package.display_name }}
                                                    </h3>
                                                    <p class="text-sm text-gray-500">
                                                        Created {{ investment.created_at|date:"M d, Y" }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="text-right">
                                            <div class="grid grid-cols-3 gap-4 text-center">
                                                <div>
                                                    <div class="text-sm text-gray-500">Trading Amount</div>
                                                    <div class="font-semibold text-gray-900">
                                                        {{ investment.total_investment|floatformat:2 }}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-sm text-gray-500">Profit Range</div>
                                                    <div class="font-semibold text-primary-600">
                                                        {{ investment.package.profit_min }}-{{ investment.package.profit_max }}%
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-sm text-gray-500">Duration</div>
                                                    <div class="font-semibold text-gray-900">
                                                        {{ investment.package.duration_hours }}h
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="ml-4">
                                            <i class="fas fa-chevron-right text-gray-400"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden radio input -->
                                    <input type="radio" 
                                           name="investment" 
                                           value="{{ investment.id }}" 
                                           class="hidden investment-radio"
                                           id="investment-{{ investment.id }}">
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Confirmation Checkbox -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <label class="flex items-start space-x-3">
                                    <input type="checkbox" 
                                           name="confirm_trade" 
                                           required
                                           class="mt-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                    <div class="text-sm">
                                        <div class="font-medium text-gray-900">Trading Confirmation</div>
                                        <div class="text-gray-600 mt-1">
                                            I understand that this will start a 24-hour automated trading session. 
                                            I confirm that I want to proceed with this trade and acknowledge the associated risks.
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" 
                                    id="submit-btn"
                                    class="w-full bg-gradient-primary text-white py-4 px-6 rounded-lg font-semibold text-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    disabled>
                                <span id="submit-text">
                                    <i class="fas fa-rocket mr-2"></i>Start Trading Session
                                </span>
                                <span id="submit-loading" class="hidden">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Initiating Trade...
                                </span>
                            </button>
                        </form>
                    {% else %}
                        <!-- No Investments Available -->
                        <div class="text-center py-12">
                            <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Investments Available</h3>
                            <p class="text-gray-500 mb-6">
                                You need to create an investment first before you can start trading. 
                                All your current investments may already have active trades.
                            </p>
                            <div class="space-x-4">
                                <a href="{% url 'trading:packages' %}" class="btn-primary">
                                    <i class="fas fa-plus mr-2"></i>Create Investment
                                </a>
                                <a href="{% url 'trading:trades' %}" class="btn-secondary">
                                    <i class="fas fa-history mr-2"></i>View Trades
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trade Preview Sidebar -->
            <div class="space-y-6">
                <!-- Selected Investment Preview -->
                <div id="trade-preview" class="trade-preview rounded-2xl p-6 card-shadow hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Trade Preview</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-500 uppercase tracking-wide">Package</label>
                            <div id="preview-package" class="font-semibold text-gray-900">-</div>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-500 uppercase tracking-wide">Trading Amount</label>
                            <div id="preview-amount" class="text-xl font-bold text-primary-600">-</div>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-500 uppercase tracking-wide">Expected Profit Range</label>
                            <div id="preview-profit" class="font-semibold text-success-600">-</div>
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-500 uppercase tracking-wide">Duration</label>
                            <div id="preview-duration" class="font-semibold text-gray-900">-</div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Completion Time:</span>
                                <span id="preview-completion" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Tips -->
                <div class="bg-white rounded-2xl p-6 card-shadow">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-lightbulb text-warning-500 mr-2"></i>Trading Tips
                    </h3>
                    
                    <ul class="space-y-3 text-sm text-gray-600">
                        <li class="flex items-start">
                            <i class="fas fa-check text-success-500 mr-2 mt-1 flex-shrink-0"></i>
                            <span>Trading sessions run for 24 hours automatically</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-success-500 mr-2 mt-1 flex-shrink-0"></i>
                            <span>Profits are calculated and credited upon completion</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-success-500 mr-2 mt-1 flex-shrink-0"></i>
                            <span>You can only have one active trade per investment</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-success-500 mr-2 mt-1 flex-shrink-0"></i>
                            <span>Monitor progress in your dashboard</span>
                        </li>
                    </ul>
                </div>

                <!-- Risk Warning -->
                <div class="bg-warning-50 border border-warning-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-warning-600 mt-1 mr-3 flex-shrink-0"></i>
                        <div class="text-sm">
                            <h4 class="font-semibold text-warning-800 mb-1">Risk Disclosure</h4>
                            <p class="text-warning-700">
                                Trading involves risk. While our algorithms aim to generate profits within the specified ranges, 
                                returns are not guaranteed. Only trade with amounts you can afford to lose.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Support Contact -->
                <div class="bg-white rounded-lg p-4 card-shadow">
                    <h4 class="font-semibold text-gray-900 mb-2">Need Help?</h4>
                    <p class="text-sm text-gray-600 mb-3">
                        Our support team is available 24/7 to assist you with trading questions.
                    </p>
                    <a href="{% url 'core:support_tickets' %}" class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                        Contact Support <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Markets Closed Content -->
        <div class="text-center py-12">
            <div class="max-w-md mx-auto">
                <div class="mb-6">
                    <i class="fas fa-clock text-gray-300 text-6xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Come Back During Market Hours</h3>
                <p class="text-gray-600 mb-6">
                    Trading is available Monday through Friday from 8:00 AM to 6:00 PM. 
                    This ensures optimal market conditions for your trades.
                </p>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-sm text-gray-600">
                        <div class="font-medium mb-2">Trading Schedule:</div>
                        <div>Monday - Friday: 8:00 AM - 6:00 PM</div>
                        <div>Saturday - Sunday: Closed</div>
                    </div>
                </div>
                <div class="space-x-4">
                    <a href="{% url 'trading:dashboard' %}" class="btn-primary">
                        <i class="fas fa-chart-line mr-2"></i>View Dashboard
                    </a>
                    <a href="{% url 'trading:trades' %}" class="btn-secondary">
                        <i class="fas fa-history mr-2"></i>Previous Trades
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 confirmation-modal flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95" id="modal-content">
        <div class="text-center">
            <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-rocket text-primary-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirm Trade Initiation</h3>
            <p class="text-gray-600 mb-6">
                You are about to start a 24-hour trading session. Are you sure you want to proceed?
            </p>
            
            <div id="modal-details" class="bg-gray-50 rounded-lg p-4 mb-6 text-sm text-left">
                <!-- Details will be populated by JavaScript -->
            </div>
            
            <div class="flex space-x-4">
                <button onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-800 py-3 px-4 rounded-lg font-medium hover:bg-gray-300 transition-colors duration-200">
                    Cancel
                </button>
                <button onclick="confirmTrade()" class="flex-1 bg-gradient-primary text-white py-3 px-4 rounded-lg font-medium hover:shadow-lg transition-all duration-200">
                    Start Trade
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedInvestment = null;
let selectedData = {};

// Global functions (so onclick can access them)
function selectInvestment(id, packageName, amount, profitMin, profitMax, duration) {
    console.log('selectInvestment called with:', { id, packageName, amount, profitMin, profitMax, duration });
    
    // Remove previous selection
    document.querySelectorAll('.investment-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select new investment
    const selectedCard = document.querySelector(`#investment-${id}`).closest('.investment-card');
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
    
    // Check the radio button
    const radioInput = document.getElementById(`investment-${id}`);
    if (radioInput) {
        radioInput.checked = true;
    }
    
    // Store selection data
    selectedInvestment = id;
    selectedData = {
        packageName,
        amount,
        profitMin,
        profitMax,
        duration
    };
    
    console.log('Investment selected:', id, selectedData); // Debug log
    
    // Update preview
    updateTradePreview();
    
    // Enable submit button if form is valid
    updateSubmitButton();
}

function updateTradePreview() {
    const previewElement = document.getElementById('trade-preview');
    if (!selectedInvestment || !previewElement) {
        if (previewElement) {
            previewElement.classList.add('hidden');
        }
        return;
    }
    
    const minProfit = (selectedData.amount * selectedData.profitMin / 100);
    const maxProfit = (selectedData.amount * selectedData.profitMax / 100);
    const completionTime = new Date();
    completionTime.setHours(completionTime.getHours() + selectedData.duration);
    
    // Safely update preview elements
    const elements = {
        'preview-package': selectedData.packageName,
        'preview-amount': `${selectedData.amount.toFixed(2)} {{ user.wallet.currency }}`,
        'preview-profit': `${minProfit.toFixed(2)} - ${maxProfit.toFixed(2)} {{ user.wallet.currency }}`,
        'preview-duration': `${selectedData.duration} Hours`,
        'preview-completion': completionTime.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        })
    };
    
    Object.entries(elements).forEach(([id, text]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = text;
        }
    });
    
    previewElement.classList.remove('hidden');
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submit-btn');
    const confirmCheckbox = document.querySelector('input[name="confirm_trade"]');
    
    console.log('Updating submit button:', { // Debug log
        selectedInvestment, 
        checkboxExists: !!confirmCheckbox,
        checkboxChecked: confirmCheckbox ? confirmCheckbox.checked : false
    });
    
    if (selectedInvestment && confirmCheckbox && confirmCheckbox.checked) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        console.log('Submit button enabled');
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        console.log('Submit button disabled - reasons:', {
            noInvestment: !selectedInvestment,
            noCheckbox: !confirmCheckbox,
            checkboxNotChecked: confirmCheckbox ? !confirmCheckbox.checked : 'no checkbox'
        });
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    
    // Form submission handling
    document.getElementById('trade-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!selectedInvestment) {
            alert('Please select an investment first.');
            return;
        }
        
        showConfirmationModal();
    });
    
    function showConfirmationModal() {
        const modal = document.getElementById('confirmation-modal');
        const modalContent = document.getElementById('modal-content');
        const modalDetails = document.getElementById('modal-details');
        
        const minProfit = (selectedData.amount * selectedData.profitMin / 100);
        const maxProfit = (selectedData.amount * selectedData.profitMax / 100);
        
        modalDetails.innerHTML = `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-600">Package:</span>
                    <span class="font-medium">${selectedData.packageName}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Trading Amount:</span>
                    <span class="font-medium">${selectedData.amount.toFixed(2)} {{ user.wallet.currency }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Expected Profit:</span>
                    <span class="font-medium text-success-600">${minProfit.toFixed(2)} - ${maxProfit.toFixed(2)} {{ user.wallet.currency }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Duration:</span>
                    <span class="font-medium">${selectedData.duration} Hours</span>
                </div>
            </div>
        `;
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 50);
    }
    
    function closeModal() {
        const modal = document.getElementById('confirmation-modal');
        const modalContent = document.getElementById('modal-content');
        
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }
    
    function confirmTrade() {
        const submitText = document.getElementById('submit-text');
        const submitLoading = document.getElementById('submit-loading');
        
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        
        closeModal();
        showLoading();
        
        // Submit the form
        document.getElementById('trade-form').submit();
    }
    
    // Listen for confirmation checkbox changes
    const confirmCheckbox = document.querySelector('input[name="confirm_trade"]');
    if (confirmCheckbox) {
        confirmCheckbox.addEventListener('change', updateSubmitButton);
    }
    
    // Initialize button state on page load
    updateSubmitButton();
    
    // Add event delegation for investment cards as backup
    document.addEventListener('click', function(e) {
        const investmentCard = e.target.closest('.investment-card');
        if (investmentCard) {
            const radioInput = investmentCard.querySelector('input[type="radio"]');
            if (radioInput) {
                const investmentId = radioInput.value;
                // Try to get the onclick attribute data or parse from the radio input ID
                radioInput.click();
                console.log('Investment card clicked via delegation:', investmentId);
            }
        }
    });
    
    // Also listen for radio button changes directly
    document.querySelectorAll('input[name="investment"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                console.log('Radio button changed to:', this.value);
                // Update selectedInvestment from radio value if selectInvestment wasn't called
                if (!selectedInvestment || selectedInvestment != this.value) {
                    selectedInvestment = this.value;
                    updateSubmitButton();
                }
            }
        });
    });
    
    // Close modal when clicking outside
    document.getElementById('confirmation-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

}); // End DOMContentLoaded
</script>
{% endblock %}