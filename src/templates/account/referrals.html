{% extends 'base.html' %}
{% load static %}

{% block title %}Referral Program - TradeVision{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --secondary: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --light-bg: #f8fafc;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        --card-hover: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .card {
        background: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .card:hover {
        box-shadow: var(--card-hover);
    }
    
    .card-header {
        padding: 1.25rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .btn {
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-primary {
        background: linear-gradient(to right, var(--primary), var(--primary-dark));
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-success {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .btn-secondary {
        background: #f1f5f9;
        color: #64748b;
    }
    
    .btn-secondary:hover {
        background: #e2e8f0;
    }
    
    .form-control {
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        outline: none;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    .referral-code {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
        font-family: monospace;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 1px;
    }
    
    .share-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        color: white;
    }
    
    .whatsapp {
        background: linear-gradient(to right, #25D366, #128C7E);
    }
    
    .whatsapp:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    }
    
    .telegram {
        background: linear-gradient(to right, #0088cc, #005580);
    }
    
    .telegram:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 136, 204, 0.4);
    }
    
    .step-card {
        display: flex;
        align-items: center;
        padding: 1.25rem;
        background: #f8fafc;
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .step-card:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
    }
    
    .step-number {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .referral-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .referral-table th {
        background: #f8fafc;
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .referral-table td {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .referral-table tr:last-child td {
        border-bottom: none;
    }
    
    .referral-table tr:hover {
        background: #f9fafb;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-active {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-inactive {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    .pagination {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: #f8fafc;
        border-top: 1px solid #e5e7eb;
    }
    
    .pagination-button {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .pagination-button:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
    
    .pagination-current {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
    }
    
    .terms-list {
        list-style: none;
        padding: 0;
    }
    
    .terms-list li {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
    }
    
    .terms-list li i {
        margin-right: 0.75rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center space-x-4 mb-6">
                <a href="{% url 'accounts:profile' %}" class="text-gray-400 hover:text-primary-600 transition-colors duration-200">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Referral Program</h1>
                    <p class="mt-2 text-gray-600">Earn rewards by inviting friends to join TradeVision</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Referral Stats -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Referral Code Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Your Referral Code</h3>
                    </div>
                    <div class="card-body">
                        <div class="referral-code mb-4 flex items-center justify-between">
                            <span>{{ referral_code }}</span>
                            <button onclick="copyToClipboard('{{ referral_code }}', 'Referral code copied!')" 
                                    class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition-all duration-200 text-white">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <button onclick="generateNewCode()" 
                                class="btn btn-secondary w-full">
                            <i class="fas fa-refresh mr-2"></i>
                            Generate New Code
                        </button>
                    </div>
                </div>

                <!-- Referral Link Card -->
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Share Your Link</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Referral Link</label>
                                <div class="flex">
                                    <input type="text" 
                                           id="referral-link" 
                                           value="{{ referral_link }}" 
                                           readonly
                                           class="form-control rounded-r-none bg-gray-50">
                                    <button onclick="copyToClipboard(document.getElementById('referral-link').value, 'Referral link copied!')" 
                                            class="btn btn-primary rounded-l-none">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Social Share Buttons -->
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="shareWhatsApp()" class="share-button whatsapp">
                                    <i class="fab fa-whatsapp mr-2"></i>
                                    WhatsApp
                                </button>
                                <button onclick="shareTelegram()" class="share-button telegram">
                                    <i class="fab fa-telegram mr-2"></i>
                                    Telegram
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Referral Statistics -->
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Your Statistics</h3>
                        
                        <div class="space-y-4">
                            <!-- Total Referrals -->
                            <div class="stat-card">
                                <div class="stat-number">{{ total_referrals }}</div>
                                <div class="stat-label">Total Referrals</div>
                            </div>

                            <!-- Total Earnings -->
                            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <div class="stat-number">${{ total_earnings|floatformat:2 }}</div>
                                <div class="stat-label">Total Earnings</div>
                            </div>

                            <!-- Commission Rate -->
                            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <div class="stat-number">10%</div>
                                <div class="stat-label">Commission Rate</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- How It Works -->
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">How It Works</h3>
                        
                        <div class="space-y-4">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Share Your Link</p>
                                    <p class="text-xs text-gray-500">Send your referral link to friends and family</p>
                                </div>
                            </div>

                            <div class="step-card">
                                <div class="step-number">2</div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">They Sign Up</p>
                                    <p class="text-xs text-gray-500">Your friends register using your referral link</p>
                                </div>
                            </div>

                            <div class="step-card">
                                <div class="step-number">3</div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Earn Commission</p>
                                    <p class="text-xs text-gray-500">Get 10% of their first investment as commission</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Referral History -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Recent Referrals -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">Recent Referrals</h3>
                    </div>
                    
                    {% if recent_referrals %}
                        <div class="divide-y divide-gray-200">
                            {% for referral in recent_referrals %}
                                <div class="px-6 py-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center mr-4">
                                                <i class="fas fa-user text-primary-600"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-900">{{ referral.referred.full_name|default:"New User" }}</p>
                                                <p class="text-sm text-gray-500">{{ referral.referred.email }}</p>
                                                <p class="text-xs text-gray-400">Joined {{ referral.created_at|date:"M d, Y" }}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-semibold text-success-600">${{ referral.commission_earned|floatformat:2 }}</div>
                                            <div class="text-xs {% if referral.is_active %}text-success-500{% else %}text-gray-500{% endif %}">
                                                {% if referral.is_active %}Active{% else %}Inactive{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="px-6 py-12 text-center">
                            <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No referrals yet</h3>
                            <p class="text-gray-500 mb-6">Start sharing your referral link to earn commissions</p>
                            <button onclick="copyToClipboard('{{ referral_link }}', 'Referral link copied!')" 
                                    class="btn btn-primary">
                                <i class="fas fa-share mr-2"></i>
                                Share Your Link
                            </button>
                        </div>
                    {% endif %}
                </div>

                <!-- All Referrals Table -->
                {% if referrals_page.object_list %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">All Referrals</h3>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="referral-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Commission</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for referral in referrals_page %}
                                    <tr>
                                        <td>
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                                    <i class="fas fa-user text-primary-600 text-xs"></i>
                                                </div>
                                                <div class="text-sm font-medium text-gray-900">{{ referral.referred.full_name|default:"New User" }}</div>
                                            </div>
                                        </td>
                                        <td class="text-sm text-gray-500">
                                            {{ referral.referred.email }}
                                        </td>
                                        <td class="text-sm text-gray-500">
                                            {{ referral.created_at|date:"M d, Y" }}
                                        </td>
                                        <td class="text-sm font-medium text-success-600">
                                            ${{ referral.commission_earned|floatformat:2 }}
                                        </td>
                                        <td>
                                            <span class="status-badge {% if referral.is_active %}status-active{% else %}status-inactive{% endif %}">
                                                {% if referral.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if referrals_page.has_other_pages %}
                        <div class="pagination">
                            <div>
                                <p class="text-sm text-gray-700">
                                    Showing {{ referrals_page.start_index }} to {{ referrals_page.end_index }} of {{ referrals_page.paginator.count }} results
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                {% if referrals_page.has_previous %}
                                    <a href="?page={{ referrals_page.previous_page_number }}" 
                                       class="pagination-button">
                                        Previous
                                    </a>
                                {% endif %}
                                
                                <span class="pagination-current">
                                    Page {{ referrals_page.number }}
                                </span>
                                
                                {% if referrals_page.has_next %}
                                    <a href="?page={{ referrals_page.next_page_number }}" 
                                       class="pagination-button">
                                        Next
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Referral Program Terms -->
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Program Terms & Conditions</h3>
                        
                        <ul class="terms-list">
                            <li>
                                <i class="fas fa-check text-success-500"></i>
                                <p>Earn 10% commission on your referral's first investment</p>
                            </li>
                            <li>
                                <i class="fas fa-check text-success-500"></i>
                                <p>Commissions are paid instantly to your wallet</p>
                            </li>
                            <li>
                                <i class="fas fa-check text-success-500"></i>
                                <p>Referred users must complete KYC verification</p>
                            </li>
                            <li>
                                <i class="fas fa-check text-success-500"></i>
                                <p>Minimum investment of $100 required for commission</p>
                            </li>
                            <li>
                                <i class="fas fa-times text-red-500"></i>
                                <p>Self-referrals and fake accounts are prohibited</p>
                            </li>
                            <li>
                                <i class="fas fa-times text-red-500"></i>
                                <p>Spam or unsolicited marketing is not allowed</p>
                            </li>
                        </ul>
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-3 mt-1"></i>
                                <div>
                                    <p class="text-sm font-medium text-blue-900">Fair Use Policy</p>
                                    <p class="text-sm text-blue-700 mt-1">
                                        We monitor all referral activities to ensure compliance with our terms. 
                                        Suspicious activity may result in commission forfeiture and account suspension.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Generate new referral code
function generateNewCode() {
    if (confirm('Are you sure you want to generate a new referral code? Your current code will no longer work.')) {
        showLoading();
        
        fetch('{% url "accounts:generate_referral_code" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                location.reload(); // Refresh to show new code
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            hideLoading();
            alert('Error generating new code. Please try again.');
        });
    }
}

// Share via WhatsApp
function shareWhatsApp() {
    const text = `Join me on TradeVision and start earning daily profits from smart trading! Use my referral code: {{ referral_code }} or click: {{ referral_link }}`;
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

// Share via Telegram
function shareTelegram() {
    const text = `Join me on TradeVision and start earning daily profits from smart trading! Use my referral code: {{ referral_code }} or click: {{ referral_link }}`;
    const url = `https://t.me/share/url?url=${encodeURIComponent('{{ referral_link }}')}&text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

// Copy to clipboard function
function copyToClipboard(text, message) {
    navigator.clipboard.writeText(text).then(() => {
        showToast(message, 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast(message, 'success');
    });
}

// Toast notification function
function showToast(message, type) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.textContent = message;
    
    // Add to document
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Show loading indicator
function showLoading() {
    const loading = document.createElement('div');
    loading.id = 'loading-indicator';
    loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    loading.innerHTML = `
        <div class="bg-white rounded-lg p-6 flex items-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600 mr-3"></div>
            <span>Processing...</span>
        </div>
    `;
    document.body.appendChild(loading);
}

// Hide loading indicator
function hideLoading() {
    const loading = document.getElementById('loading-indicator');
    if (loading) {
        loading.remove();
    }
}
</script>
{% endblock %}